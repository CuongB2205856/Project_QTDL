create table dichvu
(
    MaDV         int auto_increment
        primary key,
    TenDichVu    varchar(100) not null,
    DonGiaDichVu decimal      not null
);

create table loaiphong
(
    MaLoaiPhong  int auto_increment
        primary key,
    TenLoaiPhong varchar(100) not null,
    GiaThue      decimal      not null
);

create table phong
(
    MaPhong        int auto_increment
        primary key,
    MaLoaiPhong    int         not null,
    SoPhong        varchar(10) not null,
    SoLuongToiDa   int         not null,
    TinhTrangPhong varchar(20) not null,
    constraint SoPhong
        unique (SoPhong),
    constraint phong_ibfk_1
        foreign key (MaLoaiPhong) references loaiphong (MaLoaiPhong)
);

create index MaLoaiPhong
    on phong (MaLoaiPhong);

create table sinhvien
(
    MaSV        varchar(20)  not null
        primary key,
    HoTen       varchar(100) not null,
    GioiTinh    varchar(10)  null,
    SoDienThoai varchar(15)  null
);

create table hopdong
(
    MaHD        int auto_increment
        primary key,
    MaSV        varchar(20) not null,
    MaPhong     int         not null,
    NgayBatDau  date        not null,
    NgayKetThuc date        not null,
    constraint UQ_SV_HD
        unique (MaSV, MaPhong),
    constraint hopdong_ibfk_1
        foreign key (MaSV) references sinhvien (MaSV),
    constraint hopdong_ibfk_2
        foreign key (MaPhong) references phong (MaPhong)
);

create index MaPhong
    on hopdong (MaPhong);

create table sudungdichvu
(
    MaSDDV        int auto_increment
        primary key,
    MaHD          int not null,
    MaDV          int not null,
    SoLuongSuDung int not null,
    ThangSuDungDV int not null,
    NamSuDungDV   int not null,
    constraint UQ_SDDV
        unique (MaHD, MaDV, ThangSuDungDV, NamSuDungDV),
    constraint sudungdichvu_ibfk_1
        foreign key (MaHD) references hopdong (MaHD),
    constraint sudungdichvu_ibfk_2
        foreign key (MaDV) references dichvu (MaDV)
);

create table hoadon
(
    MaHoaDon           int auto_increment
        primary key,
    MaSDDV             int                                   not null,
    NgayLapHoaDon      date                                  not null,
    NgayHetHan         date                                  not null,
    TongTienThanhToan  decimal(15)                           not null,
    TrangThaiThanhToan varchar(20) default 'Chưa thanh toán' not null,
    constraint hoadon_ibfk_1
        foreign key (MaSDDV) references sudungdichvu (MaSDDV)
);

create index MaSDDV
    on hoadon (MaSDDV);

create index MaDV
    on sudungdichvu (MaDV);

create table users
(
    UserID    int auto_increment
        primary key,
    Username  varchar(50)                 not null,
    Password  varchar(255)                not null,
    Role      enum ('QuanLy', 'SinhVien') not null,
    MaLienKet varchar(20)                 null,
    constraint MaLienKet
        unique (MaLienKet),
    constraint Username
        unique (Username),
    constraint users_ibfk_1
        foreign key (MaLienKet) references sinhvien (MaSV)
);

